name: .NET CI/CD Proxmox

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build_and_test:
    # 1. On cible TON runner Proxmox
    # Assure-toi d'avoir mis le label 'dotnet' lors du ./config.sh, sinon mets juste [self-hosted, linux]
    runs-on: [self-hosted, linux]

    # 2. On d√©finit le dossier de travail par d√©faut pour toutes les √©tapes
    defaults:
      run:
        working-directory: ./src

    env:
      # Injection des secrets (fonctionne pareil en self-hosted)
      EnvSettings__SecretTest: ${{ secrets.SECRET_TEST }}
      # On force l'utilisation des installations globales (celles qu'on a faites manuellement)
      DOTNET_ROOT: /usr/share/dotnet

    steps:
    # √âtape A : R√©cup√©rer le code
    - name: Checkout code
      uses: actions/checkout@v4

    # √âtape B : Supprim√©e (setup-dotnet) !
    # On utilise directement le dotnet install√© sur la machine.
    - name: Check Dotnet Version
      run: dotnet --version

    # √âtape C : Restore
    # Gr√¢ce au "defaults.run.working-directory", il va chercher la solution dans ./src tout seul
    - name: Restore dependencies
      run: dotnet restore

    # √âtape D : Build
    - name: Build
      run: dotnet build --no-restore --configuration Release

    # √âtape E : Test
    - name: Test
      run: dotnet test --no-build --configuration Release --verbosity normal

      # ... Tes √©tapes de Build et Test ...

    # √âtape F : Publish (Cr√©er les fichiers finaux)
    - name: Publish
      run: dotnet publish SSO.Api/SSO.Api.csproj -c Release -o ../publish_output

    # √âtape G : D√©ploiement Local (Simple copie)
    - name: Deploy Locally
      run: |
        echo "üöÄ Arr√™t du service..."
        # On arr√™te le site le temps de la copie (si le service existe d√©j√†)
        # || true permet de ne pas planter si le service n'existe pas encore
        sudo systemctl stop sso-api.service || true

        echo "üìÇ Copie des fichiers..."
        # On cr√©e le dossier s'il n'existe pas
        sudo mkdir -p /var/www/sso-api
        
        # On copie le contenu du dossier publish vers le dossier du site
        sudo cp -r ../publish_output/* /var/www/sso-api/
        
        # On s'assure que les permissions sont bonnes (user www-data souvent utilis√© pour le web)
        sudo chown -R www-data:www-data /var/www/sso-api
        
        echo "‚úÖ Red√©marrage..."
        sudo systemctl start sso-api.service || true