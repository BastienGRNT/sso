name: .NET CI/CD Proxmox

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build_and_test:
    # 1. On cible TON runner Proxmox
    # Assure-toi d'avoir mis le label 'dotnet' lors du ./config.sh, sinon mets juste [self-hosted, linux]
    runs-on: [self-hosted, linux]

    # 2. On d√©finit le dossier de travail par d√©faut pour toutes les √©tapes
    defaults:
      run:
        working-directory: ./src

    env:
      # Injection des secrets (fonctionne pareil en self-hosted)
      EnvSettings__SecretTest: ${{ secrets.SECRET_TEST }}
      # On force l'utilisation des installations globales (celles qu'on a faites manuellement)
      DOTNET_ROOT: /usr/share/dotnet

    steps:
    # √âtape A : R√©cup√©rer le code
    - name: Checkout code
      uses: actions/checkout@v4

    # √âtape B : Supprim√©e (setup-dotnet) !
    # On utilise directement le dotnet install√© sur la machine.
    - name: Check Dotnet Version
      run: dotnet --version

    # √âtape C : Restore
    # Gr√¢ce au "defaults.run.working-directory", il va chercher la solution dans ./src tout seul
    - name: Restore dependencies
      run: dotnet restore

    # √âtape D : Build
    - name: Build
      run: dotnet build --no-restore --configuration Release

    # √âtape E : Test
    - name: Test
      run: dotnet test --no-build --configuration Release --verbosity normal

      # ... Tes √©tapes de Build et Test ...

    # √âtape F : Publish (Cr√©er les fichiers finaux)
    - name: Publish
      run: dotnet publish SSO.Api/SSO.Api.csproj -c Release -o ../publish_output

    # √âtape G : D√©ploiement Local (Simple copie)
    # √âtape G : D√©ploiement Local avec g√©n√©ration de sso.env
    - name: Deploy Locally
      run: |
        echo "‚öôÔ∏è G√©n√©ration du fichier sso.env..."
        
        # C'est ICI que tu mets tes 25 variables.
        # Le format est : NOM_VARIABLE__CLE=VALEUR
        cat <<EOF > ../publish_output/sso.env
        ASPNETCORE_ENVIRONMENT=Production
        EnvSettings__SecretTest=${{ secrets.SECRET_TEST }}
        EOF

        echo "üöÄ Arr√™t du service..."
        sudo systemctl stop sso-api.service || true

        echo "üìÇ Copie des fichiers..."
        sudo mkdir -p /var/www/sso-api
        
        # On copie tout le dossier publish (qui contient maintenant sso.env)
        sudo cp -r ../publish_output/* /var/www/sso-api/
        
        # Permissions de s√©curit√© (Important !)
        # www-data devient propri√©taire
        sudo chown -R www-data:www-data /var/www/sso-api
        # Seul le propri√©taire peut lire ce fichier (car il contient des mots de passe)
        sudo chmod 600 /var/www/sso-api/sso.env
        
        echo "‚úÖ Red√©marrage..."
        sudo systemctl start sso-api.service || true