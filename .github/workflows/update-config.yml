name: Update Config Only (No Build)

on:
  workflow_dispatch:

jobs:
  update-config:
    runs-on: [self-hosted, linux, "${{ github.ref == 'refs/heads/main' && 'prod' || 'dev' }}"]
    environment: ${{ github.ref == 'refs/heads/main' && 'Production' || 'Development' }}

    steps:
    - name: Update Configuration
      run: |
        if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
          TARGET_ENV="Production"
        else
          TARGET_ENV="Development"
        fi
        
        echo "Mise à jour de la config pour : $TARGET_ENV"

        echo "Régénération du fichier .env..."
 
        cat <<EOF | sudo tee /var/www/sso-api/.env > /dev/null
        ASPNETCORE_ENVIRONMENT=$TARGET_ENV
        ASPNETCORE_URLS=http://0.0.0.0:5000
        EnvSettings__SecretTest=${{ secrets.SECRET_TEST }}
        EOF

        echo "Mise à jour du service Systemd..."
        
        cat <<EOF | sudo tee /etc/systemd/system/sso-api.service > /dev/null
        [Unit]
        Description=Mon API SSO .NET ($TARGET_ENV)
        After=network.target
        [Service]
        WorkingDirectory=/var/www/sso-api
        ExecStart=/usr/bin/dotnet /var/www/sso-api/SSO.Api.dll
        User=www-data
        Restart=always
        RestartSec=10
        KillSignal=SIGINT
        SyslogIdentifier=sso-api
        EnvironmentFile=/var/www/sso-api/.env
        [Install]
        WantedBy=multi-user.target
        EOF

        sudo systemctl daemon-reload

        echo "Permissions..."
        sudo chmod 600 /var/www/sso-api/.env
        sudo chown www-data:www-data /var/www/sso-api/.env

        echo "Redémarrage du service pour appliquer les changements..."
        sudo systemctl restart sso-api.service
        
        echo "Configuration mise à jour sans rebuild !"